name: APK Scanner

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  release:
    types: [created]

env:
  APP_VERSION: 2.14.0

jobs:
  build-var:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.extract.outputs.tag_name }}
      branch_name: ${{ steps.extract.outputs.branch_name }}
      build_date: ${{ steps.setdate.outputs.build_date }}
      release_url: ${{ steps.extract.outputs.release_url }}
      build_type: ${{ steps.extract.outputs.build_type }}
      build_mode: ${{ steps.extract.outputs.build_mode }}
      file_version: ${{ steps.extract.outputs.file_version }}
      app_members: ${{ steps.repo_info.outputs.app_members }}
      app_members_url: ${{ steps.repo_info.outputs.app_members_url }}
      app_contributors: ${{ steps.repo_info.outputs.app_contributors }}
      app_contributors_url: ${{ steps.repo_info.outputs.app_contributors_url }}
      core_contributors: ${{ steps.submodule_info.outputs.core_contributors }}
      core_contributors_url: ${{ steps.submodule_info.outputs.core_contributors_url }}
      plugin_contributors: ${{ steps.submodule_info.outputs.plugin_contributors }}
      plugin_contributors_url: ${{ steps.submodule_info.outputs.plugin_contributors_url }}
    steps:
      - name: Get build ID and URL
        run: |
          echo "Build ID: $GITHUB_RUN_ID"
          echo "Server URL: $GITHUB_SERVER_URL"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Build URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

      - name: Set build date
        id: setdate
        run: |
          build_date=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "Build date: $build_date"
          echo "build_date=$build_date" >> $GITHUB_OUTPUT

      - name: Extract branch or tag name and commit ID
        id: extract
        run: |
          echo "Full ref: $GITHUB_REF"
          echo "Commit ID: $GITHUB_SHA"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            tag_name=${GITHUB_REF#refs/tags/}
            echo "Tag name: $tag_name"
            echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/* ]]; then
            branch_name=${GITHUB_REF#refs/heads/}
            echo "Branch name: $branch_name"
            echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          else
            echo "Unknown ref type"
          fi

          # Determine build type
          if [[ $GITHUB_EVENT_NAME == release ]]; then
            build_type="release"

            # Release URL for release events
            release_url=$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")
            echo "Release URL: $release_url"
            echo "release_url=$release_url" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            build_type="tag"
          else
            build_type="push"
          fi
          echo "Build type: $build_type"
          echo "build_type=$build_type" >> $GITHUB_OUTPUT

          # Determine build mode
          if [[ $GITHUB_EVENT_NAME == release ]] || [[ $GITHUB_REF == refs/heads/release ]] || [[ $GITHUB_REF == refs/tags/* ]]; then
            build_mode="user"
          else
            build_mode="eng"
          fi
          echo "Build mode: $build_mode"
          echo "build_mode=$build_mode" >> $GITHUB_OUTPUT

          # Determine file version
          date=$(date -u +"%Y%m%d")
          short_commit_id=${GITHUB_SHA:0:7}
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # Tag event
            if [[ $tag_name == *"$APP_VERSION"* ]]; then
              # Tag contains APP_VERSION
              if [[ $GITHUB_EVENT_NAME == release ]]; then
                file_version="${tag_name}_${date}"
              else
                file_version="${tag_name}.tag_${date}"
              fi
            else
              # Tag does not contain APP_VERSION
              file_version="v${APP_VERSION}_${tag_name}.tag_${date}"
            fi
          elif [[ $GITHUB_REF == refs/heads/release ]]; then
            # Release branch
            file_version="v${APP_VERSION}_RC-${short_commit_id}_${date}"
          else
            # Other branches
            file_version="v${APP_VERSION}_${branch_name}-${short_commit_id}_${date}"
          fi
          echo "File version: $file_version"
          echo "file_version=$file_version" >> $GITHUB_OUTPUT

      - name: Extract repository information
        id: repo_info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract repository owner and name
          repo_owner=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          repo_name=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)

          # Get owner type (User or Organization) with error handling
          owner_type=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "$GITHUB_API_URL/orgs/$repo_owner" | jq -r '.type // empty')

          # Try to get organization members if owner is an organization
          if [[ "$owner_type" == "Organization" ]]; then
            org_members=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
              "$GITHUB_API_URL/orgs/$repo_owner/members?per_page=100" 2>/dev/null)
            # Check if the response is valid JSON and contains members
            if echo "$org_members" | jq -e 'type == "array" and length > 0' >/dev/null 2>&1; then
              # Extract member logins and join with commas
              app_members=$(echo "$org_members" | jq -r '[.[].login] | join(",")')
              app_members_url="$GITHUB_SERVER_URL/orgs/$repo_owner/people"
            fi
          fi

          # If app_members is still empty, set owner as member
          if [[ -z "$app_members" ]]; then
            app_members="$repo_owner"
            if [[ "$owner_type" == "Organization" ]]; then
              app_members_url="$GITHUB_SERVER_URL/orgs/$repo_owner/people"
            else
              app_members_url="$GITHUB_SERVER_URL/$repo_owner"
            fi
          fi

          # Extract contributors
          contributors=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/contributors?per_page=100" 2>/dev/null)
          # Check if the response is valid JSON and contains contributors
          if echo "$contributors" | jq -e 'type == "array" and length > 0' >/dev/null 2>&1; then
            # Extract contributor logins and join with commas
            app_contributors=$(echo "$contributors" | jq -r 'map(select(.type == "User")) | map(.login) | join(",")')
            app_contributors_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/graphs/contributors"
          fi

          if [[ -z "$app_contributors" ]]; then
            app_contributors=$app_members
            app_contributors_url=$app_members_url
          fi

          # Output information
          echo "Repository owner: $repo_owner"
          echo "Repository name: $repo_name"
          echo "Owner type: $owner_type"
          if [[ "$owner_type" == "Organization" ]]; then
            echo "Repository is owned by an organization: $repo_owner"
          else
            echo "Repository is owned by a user: $repo_owner"
          fi
          echo "App members: $app_members"
          echo "App members URL: $app_members_url"
          echo "App contributors: $app_contributors"
          echo "App contributors URL: $app_contributors_url"

          # Set outputs
          echo "app_members=$app_members" >> $GITHUB_OUTPUT
          echo "app_members_url=$app_members_url" >> $GITHUB_OUTPUT
          echo "app_contributors=$app_contributors" >> $GITHUB_OUTPUT
          echo "app_contributors_url=$app_contributors_url" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .gitmodules
          sparse-checkout-cone-mode: false

      - name: Extract submodule repository information
        id: submodule_info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Function to extract submodule path from .gitmodules
          extract_submodule_path() {
            local submodule_name=$1
            # Extract URL from .gitmodules file
            local submodule_url=$(grep -A 2 "\[submodule \"$submodule_name\"\]" .gitmodules | grep "url =" | cut -d'=' -f2 | xargs)

            # Handle relative URLs (starting with ../)
            if [[ $submodule_url == "../"* ]]; then
              # Extract parent repository owner
              repo_owner=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
              # Remove ../ prefix to get repo name
              local repo_name=${submodule_url#../}
              # Return full path "$repo_owner/$repo_name"
              echo "$repo_owner/$repo_name"
            fi
          }

          # Function to get contributors for a repository
          get_contributors() {
            local full_path=$1
            local api_url=""

            # Construct API URL using same host
            api_url="$GITHUB_API_URL/repos/$full_path/contributors?per_page=100"

            # Get contributors from GitHub API
            local contributors=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$api_url" 2>/dev/null)
            # Check if the response is valid JSON and contains contributors
            if echo "$contributors" | jq -e 'type == "array" and length > 0' >/dev/null 2>&1; then
              # Extract contributor logins and join with commas
              echo "$contributors" | jq -r 'map(select(.type == "User")) | map(.login) | join(",")'
            fi
          }

          # Extract core submodule contributors
          core_contributors=""
          core_contributors_url=""

          # Get core submodule path
          core_path=$(extract_submodule_path "core")
          if [[ -n "$core_path" ]]; then
            core_contributors=$(get_contributors "$core_path")
            core_contributors_url="$GITHUB_SERVER_URL/$core_path/graphs/contributors"
          fi

          # Extract plugin submodule contributors
          plugin_contributors=""
          plugin_contributors_url=""

          # Get plugin submodule path
          plugin_path=$(extract_submodule_path "plugin")
          if [[ -n "$plugin_path" ]]; then
            plugin_contributors=$(get_contributors "$plugin_path")
            plugin_contributors_url="$GITHUB_SERVER_URL/$plugin_path/graphs/contributors"
          fi

          # Output information
          echo "Core path: $core_path"
          echo "Core contributors: $core_contributors"
          echo "Core contributors URL: $core_contributors_url"
          echo "Plugin path: $plugin_path"
          echo "Plugin contributors: $plugin_contributors"
          echo "Plugin contributors URL: $plugin_contributors_url"

          # Set outputs
          echo "core_contributors=$core_contributors" >> $GITHUB_OUTPUT
          echo "core_contributors_url=$core_contributors_url" >> $GITHUB_OUTPUT
          echo "plugin_contributors=$plugin_contributors" >> $GITHUB_OUTPUT
          echo "plugin_contributors_url=$plugin_contributors_url" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: build-var
    env:
      TAG_NAME: ${{ needs.build-var.outputs.tag_name }}
      BRANCH_NAME: ${{ needs.build-var.outputs.branch_name }}
      BUILD_DATE: ${{ needs.build-var.outputs.build_date }}
      RELEASE_URL: ${{ needs.build-var.outputs.release_url }}
      BUILD_TYPE: ${{ needs.build-var.outputs.build_type }}
      BUILD_MODE: ${{ needs.build-var.outputs.build_mode }}
      FILE_VERSION: ${{ needs.build-var.outputs.file_version }}
      APP_MEMBERS: ${{ needs.build-var.outputs.app_members }}
      APP_MEMBERS_URL: ${{ needs.build-var.outputs.app_members_url }}
      APP_CONTRIBUTORS: ${{ needs.build-var.outputs.app_contributors }}
      APP_CONTRIBUTORS_URL: ${{ needs.build-var.outputs.app_contributors_url }}
      CORE_CONTRIBUTORS: ${{ needs.build-var.outputs.core_contributors }}
      CORE_CONTRIBUTORS_URL: ${{ needs.build-var.outputs.core_contributors_url }}
      PLUGIN_CONTRIBUTORS: ${{ needs.build-var.outputs.plugin_contributors }}
      PLUGIN_CONTRIBUTORS_URL: ${{ needs.build-var.outputs.plugin_contributors_url }}
    steps:
      - name: Set up JDK 1.8
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 8.0.402+6

      - name: Check out repository code
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Build - Core
        run: ./mvnw -f core/pom.xml package

      - name: Build - Plugins
        run: ./mvnw -f plugin/pom.xml package

      - name: Build - APK Scanner
        run: ./mvnw package
          -Dapp.version="${{ env.APP_VERSION }}"
          -Dapp.mode="${{ env.BUILD_MODE }}"
          -Dapp.build.type="${{ env.BUILD_TYPE }}"
          -Dapp.build.branch="${{ env.BRANCH_NAME }}${{ env.TAG_NAME }}"
          -Dapp.build.commit="$GITHUB_SHA"
          -Dapp.build.id="$GITHUB_RUN_ID"
          -Dapp.build.date="${{ env.BUILD_DATE }}"
          -Dapp.build.url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          -Dapp.source.host="$GITHUB_SERVER_URL"
          -Dapp.source.repository="$GITHUB_REPOSITORY"
          -Dapp.release.url="${{ env.RELEASE_URL }}"
          -Dapp.members="${{ env.APP_MEMBERS }}"
          -Dapp.members.url="${{ env.APP_MEMBERS_URL }}"
          -Dapp.contributors="${{ env.APP_CONTRIBUTORS }}"
          -Dapp.contributors.url="${{ env.APP_CONTRIBUTORS_URL }}"
          -Dapp.core.contributors="${{ env.CORE_CONTRIBUTORS }}"
          -Dapp.core.contributors.url="${{ env.CORE_CONTRIBUTORS_URL }}"
          -Dapp.plugin.contributors="${{ env.PLUGIN_CONTRIBUTORS }}"
          -Dapp.plugin.contributors.url="${{ env.PLUGIN_CONTRIBUTORS_URL }}"

      - name: Create tarball with preserved permissions
        run: tar -czf target.tar.gz target

      - name: Upload output
        uses: actions/upload-artifact@v7
        with:
          name: target
          path: target.tar.gz

  packaging-installer:
    needs: [build-var, build]
    runs-on: macos-15-intel
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/release')
    env:
      FILE_VERSION: ${{ needs.build-var.outputs.file_version }}
    steps:
      - name: Setup a NSIS & DPKG Package
        run: brew install makensis dpkg

      - name: Download artifacts
        uses: actions/download-artifact@v8
        with:
          path: .

      - name: Extract tarball with preserved permissions
        run: tar -xzvf ./target.tar.gz

      - name: Packaging
        run: target/package.sh

      - name: Upload output - Windows Installer
        uses: actions/upload-artifact@v7
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_win_setup.exe
          path: target/APKScanner_${{ env.FILE_VERSION }}_win_setup.exe

      - name: Upload output - Windows Portable
        uses: actions/upload-artifact@v7
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_win_portable.zip
          path: target/APKScanner_${{ env.FILE_VERSION }}_win_portable.zip

      - name: Upload output - Ubuntu Package
        uses: actions/upload-artifact@v7
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb
          path: target/APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb

      - name: Upload output - MacOS Package
        uses: actions/upload-artifact@v7
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_mac.dmg
          path: target/APKScanner_${{ env.FILE_VERSION }}_mac.dmg

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release'
        with:
          files: |
            target/APKScanner_${{ env.FILE_VERSION }}_win_setup.exe
            target/APKScanner_${{ env.FILE_VERSION }}_win_portable.zip
            target/APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb
            target/APKScanner_${{ env.FILE_VERSION }}_mac.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
