name: APK Scanner

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  release:
    types: [created]

env:
  APP_VERSION: 2.14.0

jobs:
  build-var:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.extract.outputs.tag_name }}
      branch_name: ${{ steps.extract.outputs.branch_name }}
      build_date: ${{ steps.setdate.outputs.build_date }}
      release_url: ${{ steps.extract.outputs.release_url }}
      build_type: ${{ steps.extract.outputs.build_type }}
      build_mode: ${{ steps.extract.outputs.build_mode }}
      file_version: ${{ steps.extract.outputs.file_version }}
    steps:
      - name: Get build ID and URL
        run: |
          echo "Build ID: $GITHUB_RUN_ID"
          echo "Server URL: $GITHUB_SERVER_URL"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Build URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

      - name: Set build date
        id: setdate
        run: |
          build_date=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "Build date: $build_date"
          echo "build_date=$build_date" >> $GITHUB_OUTPUT

      - name: Extract branch or tag name and commit ID
        id: extract
        run: |
          echo "Full ref: $GITHUB_REF"
          echo "Commit ID: $GITHUB_SHA"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            tag_name=${GITHUB_REF#refs/tags/}
            echo "Tag name: $tag_name"
            echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/* ]]; then
            branch_name=${GITHUB_REF#refs/heads/}
            echo "Branch name: $branch_name"
            echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          else
            echo "Unknown ref type"
          fi
          
          # Determine build type
          if [[ $GITHUB_EVENT_NAME == release ]]; then
            build_type="release"
            echo "Build type: $build_type"
            echo "build_type=$build_type" >> $GITHUB_OUTPUT
            
            # Release URL for release events
            release_url=$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")
            echo "Release URL: $release_url"
            echo "release_url=$release_url" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            build_type="tag"
            echo "Build type: $build_type"
            echo "build_type=$build_type" >> $GITHUB_OUTPUT
          else
            build_type="push"
            echo "Build type: $build_type"
            echo "build_type=$build_type" >> $GITHUB_OUTPUT
          fi
          
          # Determine build mode
          if [[ $GITHUB_EVENT_NAME == release ]] || [[ $GITHUB_REF == refs/heads/release ]] || [[ $GITHUB_REF == refs/tags/* ]]; then
            build_mode="user"
            echo "Build mode: $build_mode"
            echo "build_mode=$build_mode" >> $GITHUB_OUTPUT
          else
            build_mode="eng"
            echo "Build mode: $build_mode"
            echo "build_mode=$build_mode" >> $GITHUB_OUTPUT
          fi
          
          # Determine file version
          date=$(date -u +"%Y%m%d")
          short_commit_id=${GITHUB_SHA:0:7}
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # Tag event
            if [[ $tag_name == *"$APP_VERSION"* ]]; then
              # Tag contains APP_VERSION
              if [[ $GITHUB_EVENT_NAME == release ]]; then
                file_version="${tag_name}_${date}"
              else
                file_version="${tag_name}.tag_${date}"
              fi
              echo "File version: $file_version"
              echo "file_version=$file_version" >> $GITHUB_OUTPUT
            else
              # Tag does not contain APP_VERSION
              file_version="v${APP_VERSION}_${tag_name}.tag_${date}"
              echo "File version: $file_version"
              echo "file_version=$file_version" >> $GITHUB_OUTPUT
            fi
          elif [[ $GITHUB_REF == refs/heads/release ]]; then
            # Release branch
            file_version="v${APP_VERSION}_RC-${short_commit_id}_${date}"
            echo "File version: $file_version"
            echo "file_version=$file_version" >> $GITHUB_OUTPUT
          else
            # Other branches
            file_version="v${APP_VERSION}_${branch_name}-${short_commit_id}_${date}"
            echo "File version: $file_version"
            echo "file_version=$file_version" >> $GITHUB_OUTPUT
          fi

  build:
    runs-on: ubuntu-latest
    needs: build-var
    env:
      TAG_NAME: ${{ needs.build-var.outputs.tag_name }}
      BRANCH_NAME: ${{ needs.build-var.outputs.branch_name }}
      BUILD_DATE: ${{ needs.build-var.outputs.build_date }}
      RELEASE_URL: ${{ needs.build-var.outputs.release_url }}
      BUILD_TYPE: ${{ needs.build-var.outputs.build_type }}
      BUILD_MODE: ${{ needs.build-var.outputs.build_mode }}
      FILE_VERSION: ${{ needs.build-var.outputs.file_version }}
    steps:
      - name: Set up JDK 1.8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8.0.402+6

      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build - Core
        run: ./mvnw -f core/pom.xml package

      - name: Build - Plugins
        run: ./mvnw -f plugin/pom.xml package

      - name: Build - APK Scanner
        run: ./mvnw package
          -Dapp.version="${{ env.APP_VERSION }}"
          -Dapp.mode="${{ env.BUILD_MODE }}"
          -Dapp.build.type="${{ env.BUILD_TYPE }}"
          -Dapp.build.branch="${{ env.BRANCH_NAME }}${{ env.TAG_NAME }}"
          -Dapp.build.commit="$GITHUB_SHA"
          -Dapp.build.id="$GITHUB_RUN_ID"
          -Dapp.build.date="${{ env.BUILD_DATE }}"
          -Dapp.build.url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          -Dapp.source.host="$GITHUB_SERVER_URL"
          -Dapp.source.repository="$GITHUB_REPOSITORY"
          -Dapp.release.url="${{ env.RELEASE_URL }}"
          -Dapp.members=""
          -Dapp.members.url=""
          -Dapp.contributors=""
          -Dapp.contributors.url=""
      - name: Create tarball with preserved permissions
        run: tar -czf target.tar.gz target

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: target
          path: target.tar.gz

  packaging-installer:
    needs: [build-var, build]
    runs-on: macos-15-intel
    if: |
      github.event_name == 'release' || 
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || 
      (github.event_name == 'push' && github.ref == 'refs/heads/release')
    env:
      FILE_VERSION: ${{ needs.build-var.outputs.file_version }}
    steps:
      - name: Setup a NSIS & DPKG Package
        run: brew install makensis dpkg

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Extract tarball with preserved permissions
        run: tar -xzvf ./target/target.tar.gz

      - name: Packaging
        run: target/package.sh

      - name: Upload output - Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_win_setup.exe
          path: target/APKScanner_${{ env.FILE_VERSION }}_win_setup.exe

      - name: Upload output - Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_win_portable.zip
          path: target/APKScanner_${{ env.FILE_VERSION }}_win_portable.zip

      - name: Upload output - Ubuntu Package
        uses: actions/upload-artifact@v4
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb
          path: target/APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb

      - name: Upload output - MacOS Package
        uses: actions/upload-artifact@v4
        with:
          name: APKScanner_${{ env.FILE_VERSION }}_mac.dmg
          path: target/APKScanner_${{ env.FILE_VERSION }}_mac.dmg

  upload-to-release:
    needs: [build-var, packaging-installer]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    env:
      FILE_VERSION: ${{ needs.build-var.outputs.file_version }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./APKScanner_${{ env.FILE_VERSION }}_win_setup.exe/APKScanner_${{ env.FILE_VERSION }}_win_setup.exe
            ./APKScanner_${{ env.FILE_VERSION }}_win_portable.zip/APKScanner_${{ env.FILE_VERSION }}_win_portable.zip
            ./APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb/APKScanner_${{ env.FILE_VERSION }}_ubuntu_setup.deb
            ./APKScanner_${{ env.FILE_VERSION }}_mac.dmg/APKScanner_${{ env.FILE_VERSION }}_mac.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
